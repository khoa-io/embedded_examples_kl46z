/*
 * This is template for main module created by KSDK Project Generator. Enjoy!
 */

/*
 * [File Name]     main.c
 * [Platform]      MKL46Z256VLH4
 * [Project]       bootloader_mocktest
 * [Version]       1.00
 * [Author]        KhoaHV1
 * [Date]          28-08-2017
 * [Language]      'C'
 * [History]       1.00 - Original Release
 *
 */

#include <stdbool.h>
#include <stdint.h>
#include <stddef.h>

#include "MKL46Z4.h"
#include "board.h"
#include "gpio.h"
#include "port.h"
#include "uart.h"
#include "queue.h"
#include "srec_reader.h"
#include "loader.h"

/*******************************************************************************
 * Definitions
 ******************************************************************************/

#define BAUD_RATE (115200U)

#define PRINT_SUCCESS UART_sendArray(UART_0, (uint8_t *)">>\r\n", 4)
#define PRINT_ERR UART_sendArray(UART_0, (uint8_t *)"Error\r\n", 7)
#define PRINT_QUEUE_ERR UART_sendArray(UART_0, (uint8_t *)"QueueError\r\n", 12)

/*******************************************************************************
 * Global variables
 ******************************************************************************/

/*******************************************************************************
 * Prototypes
 ******************************************************************************/
/*!
 * @brief Main loop.
 */
void mainLoop(void);

/*!
 * @brief Parse SREC line and print checking result.
 *
 * @param line Buffer stores SREC line.
 */
void checkSrecLine(uint8_t *line);

/*!
 * @brief Initialize environment.
 */
void init(void);

/* Demo function. TODO remove when done */
void demo(void);

/*******************************************************************************
 * Code
 ******************************************************************************/

/* TODO remove when done */
void demo(void)
{
    uint8_t i = 0;

    uint8_t srec[185][95] = {
        "S02B0000443A2F73636D2F6B686F616876314066736F66742E636F6D2E766E2F46525F454D425F484E31375F6C\r\n",
        "S113A00000600020E9A40000F9A40000F9A4000005\r\n",
        "S113A010000000000000000000000000000000003C\r\n",
        "S113A020000000000000000000000000F9A400008F\r\n",
        "S113A0300000000000000000F9A4000041A8000096\r\n",
        "S113A040F9A40000F9A40000F9A40000F9A4000098\r\n",
        "S113A050F9A40000F9A40000F9A40000F9A4000088\r\n",
        "S113A060F9A40000F9A40000F9A40000F9A4000078\r\n",
        "S113A070F9A40000F9A40000F9A40000F9A4000068\r\n",
        "S113A080F9A40000F9A40000F9A40000F9A4000058\r\n",
        "S113A090F9A40000F9A40000F9A40000F9A4000048\r\n",
        "S113A0A0F9A40000F9A40000F9A40000F9A4000038\r\n",
        "S113A0B0F9A40000F9A40000F9A4000099A7000085\r\n",
        "S113A400FFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFF59\r\n",
        "S113A41010B5064C2378002B07D1054B002B02D036\r\n",
        "S113A420044800E000BF0123237010BD6CE0FF1F4F\r\n",
        "S113A43000000000D0AD0000084B10B5002B03D085\r\n",
        "S113A4400749084800E000BF07480368002B00D113\r\n",
        "S113A45010BD064B002BFBD09847F9E70000000025\r\n",
        "S113A46070E0FF1FD0AD000068E0FF1F0000000097\r\n",
        "S113A470164B002B00D1144B9D46402292029A1A8F\r\n",
        "S113A480924600218B460F461348144A121A00F0D4\r\n",
        "S113A4907FFC0F4B002B00D098470E4B002B00D0B5\r\n",
        "S113A4A098470020002104000D000D48002802D028\r\n",
        "S113A4B00C4800E000BF00F047FC2000290000F039\r\n",
        "S113A4C087FA00F02BFCC046000008000060002062\r\n",
        "S113A4D000000000000000006CE0FF1F90E0FF1F80\r\n",
        "S113A4E0000000000000000072B600F0A7FB00F0BE\r\n",
        "S113A4F0B1FB62B6FFF7BCFF00480047F9A40000B7\r\n",
        "S113A500002243088B4274D303098B425FD3030AAE\r\n",
        "S113A5108B4244D3030B8B4228D3030C8B420DD3C1\r\n",
        "S113A520FF22090212BA030C8B4202D3121209024F\r\n",
        "S113A53065D0030B8B4219D300E0090AC30B8B428D\r\n",
        "S113A54001D3CB03C01A5241830B8B4201D38B033B\r\n",
        "S113A550C01A5241430B8B4201D34B03C01A5241E0\r\n",
        "S113A560030B8B4201D30B03C01A5241C30A8B4223\r\n",
        "S113A57001D3CB02C01A5241830A8B4201D38B020E\r\n",
        "S113A580C01A5241430A8B4201D34B02C01A5241B2\r\n",
        "S113A590030A8B4201D30B02C01A5241CDD2C30924\r\n",
        "S113A5A08B4201D3CB01C01A524183098B4201D3A0\r\n",
        "S113A5B08B01C01A524143098B4201D34B01C01A8B\r\n",
        "S113A5C0524103098B4201D30B01C01A5241C30803\r\n",
        "S113A5D08B4201D3CB00C01A524183088B4201D372\r\n",
        "S113A5E08B00C01A524143088B4201D34B00C01A5E\r\n",
        "S113A5F05241411A00D20146524110467047FFE7CA\r\n",
        "S113A60001B5002000F006F802BDC0460029F7D0CD\r\n",
        "S113A61076E770477047C04680B582B000AF02004D\r\n",
        "S113A620FB1D1A70064BFA1D127811001F220A40F6\r\n",
        "S113A630012191400A001A60C046BD4602B080BDA7\r\n",
        "S113A64000E100E080B582B000AF0200FB1D1A708B\r\n",
        "S113A6500749FB1D1B781A001F23134001229A404F\r\n",
        "S113A660C0235B00CA50C046BD4602B080BDC04690\r\n",
        "S113A67000E100E0B0B582B000AF02003960FB1D1C\r\n",
        "S113A6801A70FB1D1B787F2B32D92F4CFB1D1B78B6\r\n",
        "S113A6901A000F231340083B99082B4AFB1D1B7813\r\n",
        "S113A6A018000F230340083B9B0806339B00D31874\r\n",
        "S113A6B004331B68FA1D1278100003220240D200F2\r\n",
        "S113A6C0FF2090400200D2431A403B689B01FF20C8\r\n",
        "S113A6D01840FB1D1B781D0003232B40DB00984012\r\n",
        "S113A6E003001A438B1D9B00E31804331A6027E010\r\n",
        "S113A6F0164CFB1D1B785BB29B081449FA1D12789B\r\n",
        "S113A70052B29208C03292005258F91D09780800DA\r\n",
        "S113A71003210140C900FF2088400100C9431140C2\r\n",
        "S113A7203A689201FF201040FA1D127815000322A6\r\n",
        "S113A7302A40D200904002000A43C0339B001A51C1\r\n",
        "S113A740C046BD4602B0B0BD00ED00E000E100E04F\r\n",
        "S113A75080B582B000AF78607B68013B0C4A9342BD\r\n",
        "S113A76001D9012310E00B4B7A68013A5A600123A6\r\n",
        "S113A7705B4203211800FFF77DFF064B00229A601D\r\n",
        "S113A780044B07221A6000231800BD4602B080BDA6\r\n",
        "S113A790FFFFFF0010E000E080B500AF244B032171\r\n",
        "S113A7A0180000F03AFA031E0DD0214B03211800C3\r\n",
        "S113A7B000F01EFA1F4B00220521180000F0DAF900\r\n",
        "S113A7C01D4B00221A601A4B0C21180000F025FAC8\r\n",
        "S113A7D0031E2AD0164B0C21180000F009FA174B5F\r\n",
        "S113A7E01B785A1E9341DBB201225340DBB21A1C80\r\n",
        "S113A7F001231340DAB2114B1A70104B1B78002B53\r\n",
        "S113A80009D00D4B00221A600A4B002205211800C2\r\n",
        "S113A81000F0B0F909E0084B012252421A60054BDE\r\n",
        "S113A82001220521180000F0A5F9C046BD4680BDEF\r\n",
        "S113A83000B00440C0F00F4000E0FF1F8CE0FF1F99\r\n",
        "S113A84080B500AF294B1B685A1C284B1A60284B53\r\n",
        "S113A8501B68002B04DB264B1B685A1C244B1A6014\r\n",
        "S113A860224B1A68FA239B009A4205D1214B0022FD\r\n",
        "S113A8701D21180000F07EF91C4B1B681E4A9342F0\r\n",
        "S113A88008DD1C4B01221D21180000F073F9174B41\r\n",
        "S113A89000221A60164B1B68184A934210DD184BAD\r\n",
        "S113A8A01B7801225340DBB2002B09D0154B012247\r\n",
        "S113A8B00521180000F05EF90D4B012252421A6086\r\n",
        "S113A8C00B4B1A68FA235B009A420BD10C4B1B7892\r\n",
        "S113A8D0002B07D00B4B0521180000F074F9044B32\r\n",
        "S113A8E000221A60C046BD4680BDC04688E0FF1FF6\r\n",
        "S113A8F000E0FF1F00F10F40AF040000B70B0000A1\r\n",
        "S113A9008CE0FF1FC0F00F4080B500AFC046BD46CD\r\n",
        "S113A91080BD000080B500AF01220521032000F0B6\r\n",
        "S113A9205FF801221D21042000F05AF800220321BF\r\n",
        "S113A930022000F055F800220C21022000F050F80B\r\n",
        "S113A9401F4B01221D21180000F014F91D4B012298\r\n",
        "S113A9500521180000F00EF91B4B1A68FA23990020\r\n",
        "S113A9601000FFF7CDFD03001800FFF7F1FE031EF2\r\n",
        "S113A9700CD0134B00221D21180000F0FBF8114BE2\r\n",
        "S113A98001220521180000F0F5F817E00F4B0F4ADB\r\n",
        "S113A990D268902109030A43DA600C4B0B4A126B0C\r\n",
        "S113A9A0902109030A431A631F20FFF74BFE1F205F\r\n",
        "S113A9B0FFF732FE00211F20FFF75CFEBD4680BD7D\r\n",
        "S113A9C000F10F40C0F00F4004E0FF1F00B004404E\r\n",
        "S113A9D080B500AFFFF79EFFFFF796FFFCE700008E\r\n",
        "S113A9E090B58DB000AF040008001100FB1D221CBF\r\n",
        "S113A9F01A70BB1D021C1A707B1D0A1C1A701C23C2\r\n",
        "S113AA00FB18574A13CA13C303CA03C30823FB180A\r\n",
        "S113AA10544A13CA13C303CA03C35349524A534B78\r\n",
        "S113AA20D358FA1D127809320120904002001343D2\r\n",
        "S113AA304E4A8B50FB1D1B78002B04D0FB1D1B784A\r\n",
        "S113AA40042B00D987E0FB1D1A781C23FB18920005\r\n",
        "S113AA50D358BA1D1278F91D08781C217918800082\r\n",
        "S113AA604158B81D00788000415841480140920087\r\n",
        "S113AA70D150FB1D1A781C23FB189200D358BA1D21\r\n",
        "S113AA801278F91D08781C21791880004158B81DE6\r\n",
        "S113AA900078800041588020400001439200D1504A\r\n",
        "S113AAA07B1D1B78012B14D1FB1D1A780823FB187E\r\n",
        "S113AAB09200D358FA1D11780822BA1889008A58CE\r\n",
        "S113AAC05269B91D09780120884001000A435A617E\r\n",
        "S113AAD042E0FB1D1A780823FB189200D358FA1D94\r\n",
        "S113AAE011780822BA1889008A585269B91D097860\r\n",
        "S113AAF0012088400100C9430A405A61FB1D1A78AD\r\n",
        "S113AB001C23FB189200D358BA1D1278F91D08783B\r\n",
        "S113AB101C21791880004158B81D007880004158E4\r\n",
        "S113AB20022001439200D150FB1D1A781C23FB180C\r\n",
        "S113AB309200D358BA1D1278F91D08781C2179188F\r\n",
        "S113AB4080004158B81D007880004158012001431D\r\n",
        "S113AB509200D15000E0C046BD460DB090BDC04645\r\n",
        "S113AB60A4AD0000B8AD000000700440381000002F\r\n",
        "S113AB70FFF8FFFF80B582B000AF786008001100D5\r\n",
        "S113AB80FB1C021C1A70BB1C0A1C1A70BB1C1B7811\r\n",
        "S113AB90002B0AD17B689B68FA1C12780121914032\r\n",
        "S113ABA00A001A437B689A6009E07B685B68FA1CB8\r\n",
        "S113ABB01278012191400A001A437B685A60C0460A\r\n",
        "S113ABC0BD4602B080BD80B582B000AF78600A0097\r\n",
        "S113ABD0FB1C1A707B68DB68FA1C12780121914017\r\n",
        "S113ABE00A001A437B68DA60C046BD4602B080BDE5\r\n",
        "S113ABF080B582B000AF786039607B683A689200B3\r\n",
        "S113AC00D358802252041A4311007B683A68920098\r\n",
        "S113AC10D150C046BD4602B080BD80B582B000AF01\r\n",
        "S113AC20786039607B683A689200D25880235B046C\r\n",
        "S113AC3013401800BD4602B080BD000080B500AFCF\r\n",
        "S113AC40034A88235B010021D150C046BD4680BD24\r\n",
        "S113AC500070044080B588B000AF274BFB60274AE2\r\n",
        "S113AC60274B9A4216D00023FB610AE0244BFA6971\r\n",
        "S113AC709200D158214BFA699200D150FB690133FB\r\n",
        "S113AC80FB61FB689A08FB699A42EFD81D4B1B4A8B\r\n",
        "S113AC909A6002E01B4B1A4A9A601B4BBB611B4B28\r\n",
        "S113ACA07B611B4BBB60BA687B69D31AFB6107E00D\r\n",
        "S113ACB0BB695A1CBA617A69511C796112781A709D\r\n",
        "S113ACC0FB695A1EFA61002BF2D1124B3B61124B05\r\n",
        "S113ACD07B607A683B69D31AFB6104E03B695A1CC8\r\n",
        "S113ACE03A6100221A70FB695A1EFA61002BF5D1F1\r\n",
        "S113ACF0C046BD4608B080BD0000000000A00000B2\r\n",
        "S113AD0000A0000000ED00E000E0FF1FF8AD00002F\r\n",
        "S113AD1064AE00006CE0FF1F90E0FF1F084B10B50D\r\n",
        "S113AD200400002B02D0002100E000BF054B18688E\r\n",
        "S113AD30836A002B00D09847200000F031F8C04609\r\n",
        "S113AD4000000000CCAD000070B500260C4D0D4C89\r\n",
        "S113AD50641BA410A64209D1002600F039F80A4D5C\r\n",
        "S113AD600A4C641BA410A64205D170BDB300EB5875\r\n",
        "S113AD7098470136EEE7B300EB5898470136F2E7FF\r\n",
        "S113AD80F0AD0000F0AD0000F0AD0000F4AD000047\r\n",
        "S113AD9003008218934200D1704719700133F9E718\r\n",
        "S113ADA0FEE7C0460090044000A0044000B0044008\r\n",
        "S113ADB000C0044000D0044000F00F4040F00F40B9\r\n",
        "S113ADC080F00F40C0F00F4000F10F4008E0FF1F7B\r\n",
        "S113ADD0F8B5C046F8BC08BC9E467047F8B5C046F6\r\n",
        "S10BADE0F8BC08BC9E46704754\r\n",
        "S10BADE888F6FF7F0100000062\r\n",
        "S107ADF039A400007E\r\n",
        "S107ADF411A40000A2\r\n",
        "S113ADF8FFFFFFFF0000400100000000000000000A\r\n",
        "S113AE080000000000000000000000000000000036\r\n",
        "S113AE180000000000000000000000000000000026\r\n",
        "S113AE280000000000000000000000000000000016\r\n",
        "S113AE380000000000000000000000000000000006\r\n",
        "S113AE4800000000000000000000000000000000F6\r\n",
        "S10FAE58000000000000000000000000EA\r\n",
        "S903A4E96F\r\n"
    };

    if (!LOADER_preload())
    {
        return;
    }

    for (i = 0; i < 183; ++i)
    {
        checkSrecLine(srec[i]);
    }

    LOADER_runApp();
}

void checkSrecLine(uint8_t *line)
{
    parsed_dat_t parsedData;
    parse_status_t status = e_parseStatus_undefined;
    status = parseData(line, &parsedData);

    if (status == e_parseStatus_inprogress)
    {
        LOADER_write(&parsedData);
    }
}

void mainLoop(void)
{
    /* Buffers and temporary variables */
    static uint8_t buff[MAX_RECORD_SIZE + 1] = { 0 };
    /* Indexing on `buff` */
    static uint16_t i = 0;

    /* Pop from bottom of queue */
    queue_item_t *bot = NULL;
    /* Indexing on `bot->dat` */
    uint8_t j = 0;

    /* Error code */
    uint32_t rc = QUEUE_ERR_NONE;

    if (QUEUE_isEmpty())
    {
        /* Data is not ready => abort */
        return;
    }

    /* Data is ready! */

    /* Get new item from the bottom of the queue */
    rc = QUEUE_bot(&bot);
    if (rc != QUEUE_ERR_NONE)
    {
        /* Cannot get new item => abort */
        PRINT_QUEUE_ERR;
        return;
    }

    /* Copy data from `bot->dat` to `buff` because a SREC line can lie on one
     * or more items and/or an item can contain 2 parts of a SREC line. */
    for (j = 0; j < bot->sz; ++j, ++i)
    {
        if (bot->dat[j] == '\r')
        {
            continue;
        }
        if (bot->dat[j] == '\n')
        {
            /* UART_sendArray(UART_0, buff, i);
            UART_sendByte(UART_0, '\r');
            UART_sendByte(UART_0, '\n'); */
            i = 0;
            checkSrecLine(buff);
        }

        buff[i] = bot->dat[j];
    }

    QUEUE_pop();
}

void init(void)
{
    /* Store configuration of UART0 for configuring UART0 */
    uart_conf_t uartConf;

    /* Configure UART0 */
    uartConf.type = UART_TYPE_TRANSMITTER_MASK | UART_TYPE_RECEIVER_MASK;
    uartConf.sz = 8;
    uartConf.parityEnable = false;
    uartConf.msbf = false;
    uartConf.polarity = 0;
    uartConf.baudRate = BAUD_RATE;

    UART_enable(UART_0);
    UART_config(UART_0, &uartConf);
}

int main(void)
{
    init();

    /* TODO Remove when done */
    demo();

    while (1)
    {
        /* mainLoop(); */
    };
}
